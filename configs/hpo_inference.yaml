# HPO INFERENCE CONFIG
# Updated: 2026-01-17 to use best model combo as default
# Best combo: nv-embed-v2 + jina-reranker-v3 (nDCG@10 = 0.8658)

paths:
  data_dir: data
  groundtruth: data/groundtruth/evidence_sentence_groundtruth.csv
  sentence_corpus: data/groundtruth/sentence_corpus.jsonl
  criteria: data/DSM5/MDD_Criteira.json
  hpo_cache_dir: outputs/hpo_cache
  hpo_output_dir: outputs/hpo

models:
  # Best retriever from HPO (nv-embed-v2)
  retriever_name: nv-embed-v2
  retriever_model_id: nvidia/NV-Embed-v2
  retriever_max_length: 512
  retriever_batch_size: 8
  retriever_query_prefix: "Instruct: Given a criterion, retrieve sentences that provide direct supporting evidence.\nQuery: "
  retriever_trust_remote_code: true
  retriever_use_4bit: false

reranker:
  # Best reranker from HPO (jina-reranker-v3)
  model_name: jinaai/jina-reranker-v3
  chunk_size: 128
  dtype: auto
  max_length: 1024
  trust_remote_code: true

cache:
  dense_topk_max: 128
  sparse_topk_max: 128
  superset_max: 128
  use_sparse: false  # nv-embed-v2 is dense-only
  use_multiv: false
  rebuild_embeddings: false

split:
  seed: 42
  train_ratio: 0.8
  val_ratio: 0.1
  test_ratio: 0.1
  dev_split: val

evaluation:
  ks: [1, 3, 5, 10, 20]
  skip_no_positives: true

hpo:
  objective_metric: ndcg@10_reranked
  prune_chunk_frac: 0.1
  prune_min_queries: 50

# Search space (for nv-embed-v2, sparse and multiv should be false)
search_space:
  top_k_retriever: [8, 16, 24, 32, 48, 64]
  top_k_final: [1, 3, 5, 10]
  use_sparse: [false]  # nv-embed-v2 is dense-only
  use_multiv: [false]
  fusion_method: [rrf]  # Best method found
  score_normalization: [none, minmax_per_query, zscore_per_query]
  rrf_k: 60

# Metadata
metadata:
  updated: "2026-01-17"
  hpo_combo: "nv-embed-v2 + jina-reranker-v3"
  best_params:
    top_k_retriever: 24
    top_k_final: 10
    fusion_method: rrf
    score_normalization: none
